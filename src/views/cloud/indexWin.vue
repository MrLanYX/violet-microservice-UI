<template>
    <div class="indexWin" @contextmenu="clearRightClick">
        <div class="bottom-nav box ms flex -l- px32">
            <div class="pl5 flex -l-">
                <iconfont size="40" icon="#iconguanji" bg="#eee" text="关机" @click="logout"></iconfont>
                <el-divider direction="vertical"></el-divider>
                <iconfont size="40" icon="#iconfenxiang" bg="#eee" text="分享管理" @click="openMessage(0)"></iconfont>
                <iconfont size="40" icon="#iconshanchu" bg="#eee" text="回收站" @click="openMessage(1)"></iconfont>
            </div>
            <div class="flex" v-show="folders.findIndex(n=>n.del==true)!=-1">
                <el-divider direction="vertical"></el-divider>
                <iconfont v-for="(item,i) in folders" v-show="item.del" :key="i" size="40" icon="#iconwenjianjia" bg="#eee" :text="item.datas.sourceName" @click="item.open=true;item.style.zIndex=++zIndex"></iconfont>
                <el-divider direction="vertical"></el-divider>
            </div>
            <div class="pr10 flex -l-">
                <transition name="draw">
                    <div class="server-list flex" v-show="routerList" :style="'width:'+50*routes.length+'px'">
                        <div v-for="(item,i) in routes" class="ml5 mr5 px26" :key="i" @click="$router.push({name:item.name})">
                            <el-tooltip class="item" effect="dark" :content="item.meta.title" placement="top">
                                <svg-icon :icon-class="item.meta.icon" />
                            </el-tooltip>
                        </div>
                    </div>
                </transition>
                <iconfont size="40" :icon="routerList?'#iconxiangyouzhankai':'#iconHdonghua-xiangzuozhankai'" bg="#eee" text="服务列表" @click="routerList=!routerList"></iconfont>
                <el-divider direction="vertical"></el-divider>
                <timer></timer>
                <iconfont size="40" icon="#iconpingtai" bg="#eee" text="回到桌面" @click="goDock"></iconfont>
                <!-- <iconfont size="40" icon="#icontonggao" bg="#eee" text="消息中心" @click="openMessage(2)"></iconfont> -->
            </div>
        </div>


        <div class="folder-box" @mousedown="clearClickFun" @contextmenu="rightMenu($event,'desktop')">
            <div class="folder-box-dan" :class="{'select-folder':item.id==selectKey}" v-for="item in datas" :key="item.id" @mousedown="clickFolder($event,item.id)" @dblclick="dbClickFolder(item)" @contextmenu="rightMenu($event,'desktopFolder',item)">
                <svg class="icon" aria-hidden="true">
                    <use xlink:href="#iconwenjianjia"></use>
                </svg>
                <div class="mt5 pl5 pt3 pr5 pb3 ms px14 oto" :title="item.sourceName">
                    {{item.sourceName}}
                </div>
            </div>
        </div>


        <folder v-for="(item,i) in folders" :ref="'folder'+i" :key="i" :styles="item.style" :filesType="filesType" :open.sync="item.open" :delFlag.sync="item.del" :obj.sync="item.datas"></folder>


        <transition name="draw">
            <div class="message-box ms box" v-if="messageFalg">
                <el-input v-model="searchMessage" size="mini" placeholder="请输入搜索内容"></el-input>
                <div class="pl10 pr0 pt10 pb10 pr10" v-if="rightDataType">
                    <div v-for="(item,index) in rightDataFilter" class="mb10 message-box-card" :key="index" :style="messageFalg?('animation: cardIpnut .8s ease-out '+((index+1)*0.2)+'s both alternate;'):''">
                        <div class="message-box-title pt10 pl10 pr10 pb5 oto">{{item.fileName}}</div>
                        <div class="pt10 pl10 pr10 pb20">
                            <p><i class="el-icon-paperclip"></i> 分享创建时间：{{item.createTime}}</p>
                            <p><i class="el-icon-timer"></i> 分享剩余时长：{{item.shareType}}</p>
                            <p v-if="item.shareType!='已过期'" style="word-break: break-all"><i class="el-icon-link"></i>分享链接：<span style="user-select: all;cursor: pointer">{{item.shareUrl}}</span></p>
                            <p v-if="item.shareType!='已过期'"><i class="el-icon-key"></i> 分享提取密码：{{item.checkCode}}</p>
                        </div>
                        <div class="text-align-r pr10">
                            <el-button v-if="item.shareType!='已过期'" type="text" size="mini" icon="el-icon-document" @click="copy(item)">一键复制</el-button>
                            <el-button type="text" size="mini" icon="el-icon-delete" @click="cancelShare(item)">取消分享</el-button>
                        </div>
                    </div>
                </div>
                <div class="pl10 pr0 pt10 pb10 pr10" v-else>
                    <div v-for="(item,index) in rightDataFilter" class="mb10 message-box-card" :key="index" :style="messageFalg?('animation: cardIpnut .8s ease-out '+((index+1)*0.2)+'s both alternate;'):''">
                        <div class="message-box-title pt10 pl10 pr10 pb5 oto">{{item.fileName}}</div>
                        <div class="pt10 pl10 pr10 pb20">
                            <p><i class="el-icon-printer"></i> 删除时间：{{item.createTime}}</p>
                            <p><i class="el-icon-timer"></i> 剩余恢复时长：{{item.date}}</p>
                        </div>
                        <div class="text-align-r pr10">
                            <el-button v-if="item.date!='已过期'" type="text" size="mini" icon="el-icon-finished" @click="delOperate('restore',item)">恢复删除</el-button>
                            <el-button type="text" size="mini" icon="el-icon-delete" @click="delOperate('recover',item)">删除记录</el-button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>


        <div class="box right-click-menu pt5 pb5" v-show="rightClickFlag" :style="'top:'+rightClickTop+'px;left:'+rightClickLeft+'px'">
            <div v-for="(item,i) in rightClickList" :key="i" class="text-align-l pt5 pl10 pr20 pb5 oto" :class="{'disable':!item.show}" @click="rightMenuClick($event,item)">{{item.dictLabel}}</div>
        </div>

        <el-upload ref="upload" style="display:none" action="Fake Action" :accept="fileType" :limit="1" :auto-upload="false" :on-change="upload">
            <el-button ref="uploadBtn" size="small" type="primary"></el-button>
        </el-upload>

        <newfolder ref="newfolder" @updata="initData"></newfolder>
        <creatShare ref="creatShare"></creatShare>
        <copyShare ref="copyShare" @updata="initData"></copyShare>
    </div>
</template>

<script>
    import { flieList, newFiles, download, getShareList, delShare, delFile, getDelFileLists, Undelete, delRecord } from '@/api/center/cloud'
    import { getQueryVariable, treeFind, copy, timeToDate } from '@/utils/index'
    import { ACCEPT_CONFIG } from './config/config'
    import iconfont from './components/iconfont'
    import timer from './components/timer'
    import folder from './components/folder'
    import newfolder from './components/newfolder'
    import creatShare from './components/creatShare'
    import copyShare from './components/copyShare'
    export default {
        name: '',
        props: {},
        components: {
            iconfont,
            timer,
            folder,
            newfolder,
            creatShare,
            copyShare,
        },
        data() {
            return {
                datas: [], // 全部数据
                selectKey: null,
                folders: [],
                zIndex: 1, // 默认文件夹层级
                routerList: false, //服务列表的显示开关
                messageFalg: false, // 消息栏开关
                rightClickTop: 0, // 右键菜单定位
                rightClickLeft: 0, // 右键菜单定位
                rightClickFlag: false, // 控制右键菜单显隐
                rightClickList: [], // 右键菜单列表
                rightClickData: {}, //右击目标的数据
                rightClickType: "", // 右击目标的类型
                filesType: [], // 文件类型
                searchMessage: "", // 右侧搜索
                rightData: [], //右侧信息栏通用数据
                rightDataType: true, // 右侧信息栏数据显示类型，真为分享记录，假为回收站
                fileType: ACCEPT_CONFIG.getAll(), // 文件类型
            }
        },
        methods: {
            /**
             * 初始化加载用户文件数据
             */
            initData() {
                let ts = this
                flieList().then(res => {
                    this.datas = res.data
                })
                this.folders.forEach((n, i) => {
                    let nam = "folder" + i
                    ts.$refs[nam][0].initData()
                });
            },
            /**
             * 单选中文件夹
             */
            clickFolder(e, i) {
                window.event ? window.event.cancelBubble = true : e.stopPropagation();
                this.selectKey = i
            },
            /**
             * 双击打开文件夹
             */
            dbClickFolder(item) {
                console.log(item);
                let option = { // 当前打开的文件夹列表
                    datas: item, // 当前文件夹数据
                    open: true, // 是否打开显示在桌面
                    del: true, // 控制文件夹删除动画 通过与open配合控制三个状态 1.文件夹创建打开动画 2.文件夹小化动画 3.文件夹删除动画
                    style: {
                        top: 100, // 文件的顶部距离
                        left: 100, // 文件的左部距离
                        zIndex: 1, // 用来把文件加置顶
                        height: 450, // 盒子默认高度
                        width: 800, // 盒子默认高度
                    }
                }
                let i = this.folders.findIndex(n => n.datas.id == item.id)
                if (i != -1) {
                    // 判断为曾经打开 恢复上次移动和大小改变
                    if (!this.folders[i].del) {
                        let j = this.findFolder()
                        if (j != -1) { // 确定位置
                            this.folders[i].style.top = this.folders[j].style.top + 50
                            this.folders[i].style.left = this.folders[j].style.left + 50
                        } else {
                            this.folders[i].style.top = 100
                            this.folders[i].style.left = 100
                        }
                        this.folders[i].style.height = 450 // 确定大小
                        this.folders[i].style.width = 800
                        this.folders[i].datas = item // 更新数据
                        this.folders[i].del = true
                    }
                    this.folders[i].style.zIndex = ++this.zIndex
                    this.folders[i].open = true
                } else {
                    // 找到最上层窗口叠加位置
                    let i = this.findFolder()
                    if (i != -1) {
                        option.style.top = this.folders[i].style.top + 50
                        option.style.left = this.folders[i].style.left + 50
                    }
                    // 叠加层级
                    option.style.zIndex = ++this.zIndex
                    this.folders.push(option)
                }
            },
            /**
             * 清除系统自带右键菜单
             */
            clearRightClick() {
                window.event.returnValue = false;
            },
            /**
             * 整个桌面系统的单击操作状态清除，
             * 增加忽略过滤  传递要忽略的内容为真即可跳过
             */
            clearClickFun(val) {
                if (!val.desktop) { // 桌面文件夹选中
                    this.selectKey = null
                }
                if (!val.serverList) { // 服务列表收起
                    this.routerList = false
                }
                if (!val.message) { // 消息栏收起      
                    this.messageFalg = false
                }
                if (!val.right) { // 右键菜单
                    this.rightClickFlag = false
                }
            },
            /**
             * 回到桌面
             */
            goDock() {
                this.clearClickFun({})
                this.folders.forEach(n => {
                    n.open = false
                });
            },
            /**
             * 管理所有的右键操作
             */
            rightMenu(e, type, val) {
                // console.log(e, type, val);
                this.rightClickList.forEach(n => n.show = true) // 全部选项恢复默认开启
                this.rightClickLeft = e.pageX // 调整位置
                this.rightClickTop = e.pageY
                this.rightClickFlag = true // 开启窗口
                if (type == 'desktopFolder' && val) { // 桌面文件夹右键
                    this.rightClickData = val
                    this.rightClickType = type
                    this.rightClickList[1].show = this.rightClickList[2].show = false
                    if (val.fileType == "1") { // 桌面文件是否开启下载
                        this.rightClickList[0].show = false
                        this.rightClickList[7].show = true
                    } else {
                        this.rightClickList[0].show = true
                        this.rightClickList[7].show = false
                    }
                    return
                }
                if (type == 'tablesItem' && val.fileType == 0) { // 文件夹内单行右键
                    this.rightClickData = val
                    this.rightClickType = type
                    this.rightClickList[1].show = this.rightClickList[2].show = this.rightClickList[7].show = false
                    return
                }
                if (type == 'tablesItem' && val.fileType == 1) { // 文件右键
                    this.rightClickData = val
                    this.rightClickType = type
                    this.rightClickList[1].show = this.rightClickList[2].show = false
                    return
                }
                if (type == 'tables' && !e.path.find(n => n.nodeName == "TBODY")) { // 文件夹整体右键
                    this.rightClickData = val
                    this.rightClickType = type
                    this.rightClickList[0].show = this.rightClickList[3].show = this.rightClickList[4].show = this.rightClickList[5].show = this.rightClickList[7].show = false
                    return
                }
                if (type == 'desktop' && e.path[0].className == "folder-box") { // 桌面右键
                    this.rightClickData = { id: -1 }
                    this.rightClickType = type
                    this.rightClickList[0].show = this.rightClickList[3].show = this.rightClickList[4].show = this.rightClickList[5].show = this.rightClickList[7].show = false
                    return
                }
            },
            /**
             * 右键菜单的单击选择
             */
            rightMenuClick(e, val) {
                console.log(this.rightClickData, val);
                if (val.show) {
                    this.clearClickFun({})
                    if (val.dictValue == "F5") {
                        console.log("刷新数据");
                        this.initData()
                    }
                    if (val.dictValue == "name") {
                        console.log("重命名");
                        this.$refs.newfolder.initData("edit", this.rightClickData.id, this.rightClickData.fileSuffix)
                    }
                    if (val.dictValue == "del") {
                        console.log("删除操作");
                        this.$confirm('此操作将删除此文件（可在回收站恢复）, 是否继续?', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(() => {
                            delFile({ id: this.rightClickData.id }).then(res => {
                                this.$message.success('删除成功!');
                                this.initData()
                            })
                        }).catch(() => {
                            this.$message({
                                type: 'info',
                                message: '删除已取消'
                            });
                        });
                    }
                    if (val.dictValue == "share") {
                        console.log("分享");
                        this.$refs.creatShare.initData(this.rightClickData.id)
                    }
                    if (val.dictValue == "upload") {
                        console.log("上传文件");
                        this.$refs.uploadBtn.$el.click()
                    }
                    if (val.dictValue == "newFolder") {
                        console.log("新建文件夹");
                        this.$refs.newfolder.initData("add", this.rightClickData.id)
                    }


                    if (this.rightClickType == "desktopFolder" && val.dictValue == "open") {
                        console.log("桌面文件夹打开");
                        this.dbClickFolder(this.rightClickData)
                    }


                    if (this.rightClickType == "tablesItem" && val.dictValue == "open" && this.rightClickData.fileType == "0") {
                        console.log("文件夹内文件夹打开");
                        this.dbClickFolder(this.rightClickData)
                    }
                    if (this.rightClickType == "tablesItem" && val.dictValue == "open" && this.rightClickData.fileType == "1") {
                        console.log("文件夹内文件打开");
                    }
                    if (this.rightClickType == "tablesItem" && val.dictValue == "download" && this.rightClickData.fileType == "1") {
                        console.log("文件下载");
                        download(this.rightClickData).then(res => {})
                    }
                }
            },
            /**
             * 找到打开的文件夹里面层级最高的那个的下标
             */
            findFolder() {
                let j = -1
                let zindex = 0
                this.folders.forEach((n, i) => {
                    if (n.open && n.style.zIndex > zindex) {
                        zindex = n.style.zIndex
                        j = i
                    }
                })
                return j
            },
            /**
             * 退出登录
             */
            async logout() {
                this.$confirm('确定注销并退出系统吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.$store.dispatch('LogOut').then(() => {
                        location.href = '/index';
                    })
                })
            },
            /**
             * 开始上传方法
             */
            async upload(file, fileList) {
                const loading = this.$loading({
                    lock: true,
                    text: '文件上传中...',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.7)'
                });
                let formData = new FormData();
                let params = {
                    parentId: this.rightClickData.id,
                }
                Object.keys(params).forEach((key) => {
                    if ("undefined" != typeof params[key] && params[key] != null) {
                        formData.append(key, params[key]);
                    }
                });
                if (fileList[0] != null) {
                    formData.append("multipartFiles", fileList[0].raw);
                }
                await newFiles(formData).then(res => {
                    // console.log(res);
                    this.$message.success('上传成功！')
                    this.initData()
                    loading.close();
                })
                this.$refs.upload.clearFiles()
            },
            /**
             * 打开右边信息栏
             */
            openMessage(val) { // 0.分享管理 1.回收站
                this.rightData = []
                this.messageFalg = true
                this.searchMessage = ""
                if (val == 0) {
                    this.rightDataType = true
                    getShareList().then(res => {
                        for (const item of res.rows) {
                            if (item.shareType == "1") {
                                item.shareType = "永久"
                            } else {
                                let start = Date.parse(new Date(item.createTime))
                                let end = start + item.effectiveTime * (1000 * 3600 * 24)
                                let difference = (end - Date.parse(new Date()))
                                if (difference < 0) {
                                    item.shareType = "已过期"
                                } else {
                                    item.shareType = timeToDate(difference)
                                }
                            }
                            item.shareUrl = location.href.split("?")[0] + "?id=" + item.shareId
                        }
                        this.rightData = res.rows
                    })
                } else {
                    this.rightDataType = false
                    getDelFileLists().then(res => {
                        for (const item of res.rows) {
                            let start = Date.parse(new Date(item.createTime))
                            let end = start + (15 * 1000 * 3600 * 24)
                            let difference = (end - Date.parse(new Date()))
                            if (difference < 0) {
                                item.date = "已过期"
                            } else {
                                item.date = timeToDate(difference)
                            }
                        }
                        this.rightData = res.rows
                    })
                }
            },
            /**
             * 取消分享
             */
            cancelShare(item) {
                this.$confirm('此操作将永久取消分享, 是否继续?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    delShare(item.shareId).then(res => {
                        this.openMessage(0)
                        this.$message.success('分享删除成功!');
                    })
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '删除分享已取消'
                    });
                });
            },
            /**
             * 复制链接
             */
            copy(val) {
                let url = "摸鱼站的私人云盘ヽ(✿ﾟ▽ﾟ)ノ,链接：" + location.href.split("?")[0] + "?id=" + val.shareId + ",提取钥匙：" + val.checkCode
                copy(url)
                this.$message.success('链接已复制至粘贴板!');
            },
            /**
             * 对于删除文件后的操作
             */
            delOperate(type, val) {
                if (type == "restore") { // 恢复文件
                    Undelete({ id: val.id }).then(res => {
                        this.openMessage(1)
                        this.$message.success('文件恢复成功!');
                    })
                } else { // 删除记录
                    delRecord([val.id]).then(res => {
                        this.openMessage(1)
                        this.$message.success('记录删除成功!');
                    })
                }
            },
        },
        mounted() {
            this.initData()
            this.getDicts("cloud_right_click_list").then(response => {
                this.rightClickList = response.data;
                this.rightClickList.forEach(n => n.show = true)
            });
            this.getDicts("cloud_files_type").then(response => {
                this.filesType = response.data;
            });
            // 处理分享操作
            let key = getQueryVariable("id")
            if (key) {
                this.$refs.copyShare.initData(key)
            }
        },
        watch: {},
        computed: {
            routes() {
                let all = this.$store.getters.permission_routes
                let router1 = all.find(n => n.name == "ParentView")
                let router2 = all.find(n => n.redirect == "index")
                let routers = router1.children.concat(router2.children)
                return routers
            },
            rightDataFilter() {
                return this.rightData.filter(data => !this.searchMessage || data.fileName.toLowerCase().includes(this.searchMessage.toLowerCase()))
            },
        },
        filters: {}
    }
</script>

<style>

</style>